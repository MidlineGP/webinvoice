# .htaccess for URL Rewriting
# This file routes friendly URLs to index.php

Options -Indexes
Options +FollowSymLinks

<IfModule mod_rewrite.c>
    RewriteEngine On

    # Set the base for rewrite rules if your app is in a subdirectory
    # Example: If app is at http://localhost/store-app/, set RewriteBase /store-app/
    # If at the root (http://localhost/), RewriteBase / is usually fine or not needed.
    RewriteBase /

    # Deny access to common sensitive files
    RewriteRule ^\.gitattributes$ - [F,L]
    RewriteRule ^\.gitignore$ - [F,L]
    RewriteRule ^config\.php$ - [F,L]
    RewriteRule ^db\.php$ - [F,L]
    RewriteRule ^store\.sqlite$ - [F,L]
    RewriteRule ^\.htaccess$ - [F,L]
    RewriteRule ^README\.md$ - [F,L]
    RewriteRule ^composer\.json$ - [F,L]
    RewriteRule ^composer\.lock$ - [F,L]
    RewriteRule ^vendor/.*$ - [F,L] # Deny access to vendor directory if using Composer


    # Allow direct access to existing files and directories (like /uploads, /assets)
    RewriteCond %{REQUEST_FILENAME} -f [OR]
    RewriteCond %{REQUEST_FILENAME} -d
    RewriteRule ^ - [L]

    # --- Friendly Action Routes ---
    # Handles URLs like /action/save_settings, /action/add_customer
    RewriteRule ^action/([a-zA-Z0-9_]+)/?$ index.php?action=$1 [L,QSA]

    # --- Specific Page Routes (Generated by generate_url() function) ---
    # These rules should match the output of your generate_url() function when friendly URLs are enabled.

    # Simple Pages
    RewriteRule ^dashboard/?$ index.php?page=dashboard [L,QSA]
    RewriteRule ^customers/?$ index.php?page=customers_list [L,QSA]
    RewriteRule ^customer/add/?$ index.php?page=customer_form [L,QSA]
    RewriteRule ^products/?$ index.php?page=products_list [L,QSA]
    RewriteRule ^product/add/?$ index.php?page=product_form [L,QSA]
    RewriteRule ^invoices/?$ index.php?page=invoices_list [L,QSA]
    RewriteRule ^invoice/add/?$ index.php?page=invoice_form [L,QSA]
    RewriteRule ^settings/?$ index.php?page=settings [L,QSA]
    RewriteRule ^reports/?$ index.php?page=reports [L,QSA]

    # Pages with IDs
    RewriteRule ^customer/edit/(\d+)/?$ index.php?page=customer_form&id=$1 [L,QSA]
    RewriteRule ^customer/info/(\d+)/?$ index.php?page=customer_info&id=$1 [L,QSA]

    RewriteRule ^product/edit/(\d+)/?$ index.php?page=product_form&id=$1 [L,QSA]
    RewriteRule ^product/info/(\d+)/?$ index.php?page=product_info&id=$1 [L,QSA]

    RewriteRule ^invoice/edit/(\d+)/?$ index.php?page=invoice_form&id=$1 [L,QSA]
    RewriteRule ^invoice/detail/(\d+)/?$ index.php?page=invoice_details&id=$1 [L,QSA]
    
    # Special handling for invoice_print.php if it's meant to be accessed via a friendly URL
    # but is a standalone script not processed by index.php's layout.
    # If invoice_print.php is also routed through index.php (like other pages), this rule is fine.
    # If invoice_print.php is truly standalone, you might need a rule that points directly to it:
    # RewriteRule ^invoice/print/(\d+)/?$ pages/invoice_print.php?id=$1 [L,QSA] 
    # For now, assuming it's routed via index.php like other pages for consistency:
    RewriteRule ^invoice/print/(\d+)/?$ index.php?page=invoice_print&id=$1 [L,QSA]


    # Fallback for any other requests that are not files or directories to index.php
    # This can be useful but also might catch things unintentionally if rules above are not exhaustive.
    # It's often better to have specific rules or let unhandled requests 404.
    # For now, we rely on the specific rules above. If a friendly URL doesn't match any,
    # and it's not an existing file/dir, it will likely result in a 404 from index.php's page loading logic.

    # Optional: Remove trailing slash from URLs (for SEO consistency)
    RewriteCond %{REQUEST_FILENAME} !-d
    RewriteCond %{REQUEST_URI} (.+)/$
    RewriteRule ^ %1 [L,R=301]

</IfModule>

# For non-mod_rewrite environments, you might want to redirect to index.php
# <IfModule !mod_rewrite.c>
# ErrorDocument 404 /index.php
# </IfModule>
